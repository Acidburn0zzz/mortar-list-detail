define(["require","zepto","underscore","backbone","layouts/stack","layouts/header"],function(e){var t=e("zepto"),n=e("underscore"),r=e("backbone"),i=e("layouts/stack"),s=e("layouts/header"),o="#app",u=r.Model.extend({}),a=r.Collection.extend({model:u}),f=new i,l=r.View.extend({events:{"click button.add":"save"},stack:{open:"open"},getTitle:function(){return"Editing: "+this.model.get("title")},open:function(e){this.model=e;var n=t(this.el);(e===undefined||e===null)&&n.find("input").val(""),this.options.render&&this.options.render(this)},back:function(){f.pop()},save:function(){var e=t(this.el),n=e.find("input[name=id]"),r=e.find("input[name=title]"),i=e.find("input[name=desc]");if(n.val()){var s=m.get(n.val());s.set({title:r.val(),desc:i.val()})}else m.add(new m.model({id:m.length,title:r.val(),desc:i.val(),date:new Date}));f.pop()}}),c=r.View.extend({events:{"click button.edit":"edit"},stack:{open:"open"},getTitle:function(){return this.model.get("title")},open:function(e){this.model=e,this.model.on("change",n.bind(this.render,this)),this.render()},edit:function(){f.push(editView,this.model)},render:function(){this.options.render&&this.options.render(this)}}),h=r.View.extend({initialize:function(){this.collection.bind("add",n.bind(this.appendItem,this)),t(".contents",this.el).append('<ul class="_list"></ul>'),this.render()},render:function(){t("._list",this.el).html(""),n.each(this.collection.models,function(e){this.appendItem(e)},this)},appendItem:function(e){var n=new p({model:e,render:this.options.render});t("._list",this.el).append(n.render().el)}}),p=r.View.extend({tagName:"li",events:{click:"open"},initialize:function(){this.model.on("change",n.bind(this.render,this))},render:function(){return this.options.render&&this.options.render(this),this},open:function(){f.push(detailView,m.get(this.model.id))}}),d=r.Router.extend({routes:{"":"todos","details/:id":"details","edit/:id":"edit","new":"new_"},todos:function(){},details:function(e){},edit:function(e){},new_:function(){}});window.app=new d,r.history.start();var v=r.View.extend({initMarkup:function(){var e=t(o).height(),n=t(this.el);n.width(t("body").width());var r=new s(this.el),i=n.children("header").remove(),u=n.children();u.length?u.wrapAll('<div class="contents"></div>'):n.append('<div class="contents"></div>'),n.prepend(i);var a=n.children("header").height();n.children(".contents").css({height:e-a}),r.setTitle(i.children("h1").text()),this.header=r}}),m=new a;return{init:function(e,n,r){var i=new App({el:t("#app")});t("#app > section").each(function(){var n=t(this),r;n.is(".list")?r=new h({collection:list,el:this,render:e}):r=new v({el:this}),r.initMarkup()}),i.addView(listView),i.addView(detailView),i.addView(editView),f.push(listView)},addItem:function(e){m.add(e)},setItems:function(e){m=e},Item:u}})